<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JAGS Models • portalcasting</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="JAGS Models">
<meta property="og:description" content="portalcasting">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">portalcasting</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.25.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting_started.html">Getting started</a>
    </li>
    <li>
      <a href="../articles/current_models.html">Current models</a>
    </li>
    <li>
      <a href="../articles/adding_model_and_data.html">Adding a model and data</a>
    </li>
    <li>
      <a href="../articles/jags_models.html">JAGS modeling</a>
    </li>
    <li>
      <a href="../articles/codebase.html">portalcasting codebase</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/weecology" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/weecology" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="jags_models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>JAGS Models</h1>
                        <h4 data-toc-skip class="author">Juniper L. Simonis</h4>
            
            <h4 data-toc-skip class="date">01 December, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/weecology/portalcasting/blob/HEAD/vignettes/jags_models.Rmd" class="external-link"><code>vignettes/jags_models.Rmd</code></a></small>
      <div class="hidden name"><code>jags_models.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The <strong>portalcasting</strong> package provides utilities for working with Bayesian hierarchical models via the Just Another Gibbs Sampler (JAGS) software <span class="citation">(Plummer 2003)</span>, and the R interface used to access JAGS is the <a href="https://www.rdocumentation.org/packages/runjags/versions/2.0.4-2/topics/run.jags" class="external-link"><code>run.jags</code></a> function in the <strong>runjags</strong> package <span class="citation">(Denwood 2016)</span>. <strong>runjags</strong> is a powerful interface for JAGS that facilitates rapid expansion to multi-core processing and provides helpful summarization procedures. This vignette covers the usage of these utilities to build <strong>portalcasting</strong> models.</p>
<p>Here, we assume the user has already run through a basic installation, set up, and evaluation of the package, as covered in the <a href="https://weecology.github.io/portalcasting/articles/getting_started.html">Getting Started</a> vignette, and we assume that the user understands how to add models and data sets to the <strong>portalcasting</strong> pipeline, as covered in the <a href="https://weecology.github.io/portalcasting/articles/adding_model_and_data.html">Adding a Model and Data</a> vignette.</p>
</div>
<div class="section level2">
<h2 id="the-api-to-jags-and-runjags-in-portalcasting">The API to <strong>JAGS</strong> and <strong>runjags</strong> in <strong>portalcasting</strong><a class="anchor" aria-label="anchor" href="#the-api-to-jags-and-runjags-in-portalcasting"></a>
</h2>
<p><code><a href="https://rdrr.io/pkg/runjags/man/run.jags.html" class="external-link">runjags::run.jags</a></code> has a considerable number of arguments, which allow the user to define the model, input the data and control the MCMC algorithm used to fit the model and data. To reduce the number of top-level arguments and facilitate alignment with higher <strong>portalcasting</strong> functionality, we bundled all of the MCMC control arguments (number of chains; number of adaptation, burnin, and sampling iterations; thinning interval; modules, methods, and factories; and add-on “mutation” estimates) into a single <code>control_runjags</code> list argument, which is created by/gets its defaults from the function <code>runjags_control</code>.</p>
<p>To reduce the amount of code that needs to be written for a model and to simplify the model’s function, we provide flexible general functions for common situations that only require the user to write the <code>jags_model</code> (which is piped to the <code>model</code> argument in <code><a href="https://rdrr.io/pkg/runjags/man/run.jags.html" class="external-link">runjags::run.jags</a></code>), <code>inits</code> (initializer), and <code>monitor</code> inputs to create a model. These models do not require that the user pass any data objects, but rather take the <code>main</code> and <code>data_set</code> arguments, which allows the internal functionality to leverage <strong>portalcasting</strong>’s file-accessing capacity and do all of the loading and prepping of data required. This includes use of “past data” (from before <code>start_moon</code>) to inform the priors and model initialization function, thereby facilitating the use of generalized models (e.g., that base priors on data, rather than needing priors that are appropriate for all species).</p>
<p>The interface to <code><a href="https://rdrr.io/pkg/runjags/man/run.jags.html" class="external-link">runjags::run.jags</a></code> retains the flexibility of its <code>model</code> argument, but for general use, users should provide the function with a character value formatted as <code>"model { &lt;model code&gt;}"</code> (where <code>&lt;model code&gt;</code> is replaced with the actual code of the model). The code should be written in JAGS’s language, which is a dialect of the informal BUGS language written in C++ <span class="citation">(Plummer 2003)</span>.</p>
<p>The general function then takes the output from <code><a href="https://rdrr.io/pkg/runjags/man/runjags-package.html" class="external-link">runjags::runjags</a></code>, processes the multi-chain information (if relevant), and formats the results akin to the standard single-species <strong>portalcasting</strong> model, returning a list of <code>metadata</code> (standard model metadata), <code>cast_tab</code> (the condensed-for-use-elsewhere table of forecasts), <code>model_fits</code> (the fitted model object), and <code>model_casts</code> (the forecasts of all of the models for all species).</p>
<div class="section level3">
<h3 id="single-species-modeling-jags_ss">Single Species Modeling: <code>jags_ss</code><a class="anchor" aria-label="anchor" href="#single-species-modeling-jags_ss"></a>
</h3>
<p>Presently, the only such function is <code><a href="../reference/jags_ss.html">jags_ss()</a></code> (“JAGS Single Species”), which follows the current state of <strong>portalcasting</strong> models and treats each species and the total abundance as separate time series that it fits individually within a given data set.</p>
<p>The data objects provided to the model and initializer for a given species via <code>jags_SS</code> are:</p>
<ul>
<li>Data for the time series used to fit the model and forecast
<ul>
<li>
<code>count</code>: counts of the species</li>
<li>
<code>ntraps</code>: number of traps used</li>
<li>
<code>moon</code>: newmoon numbers</li>
<li>
<code>N</code>: number of time steps</li>
</ul>
</li>
<li>Data for the time series from before the data used to fit the model
<ul>
<li>
<code>past_count</code>: counts of the species</li>
<li>
<code>past_ntraps</code>: number of traps</li>
<li>
<code>past_moon</code>: newmoon numbers</li>
<li>
<code>past_N</code>: number of time steps</li>
</ul>
</li>
</ul>
<p>The data for the time series used to fit the model and forecast includes the as-of-yet not observed data with <code>NA</code> placeholders for <code>count</code>, an assumption of full sampling effort (max <code>ntraps</code>), and an appropriately extended <code>moon</code>. The <code>past_</code> data allow the user to inform priors and initializers as desired and should only be used within those components.</p>
<div class="section level4">
<h4 id="an-example-random-walk-jags_rw">An example: random walk (<code>jags_RW</code>)<a class="anchor" aria-label="anchor" href="#an-example-random-walk-jags_rw"></a>
</h4>
<p>The usage of <code>jags_SS</code> is exemplified by the <code>jags_RW</code> model, which is a “simple” random walk model. The observations are treated as Poisson distributed (with truncation based on the number of traps), with an underlying log-scale density that takes a random walk through time. The model has two parameters:</p>
<ul>
<li>
<code>mu</code>: the log-scale density at <code>start_moon</code>
</li>
<li>
<code>tau</code>: the precision (inverse variance) of the log-scale random walk</li>
</ul>
<p>The time series is then modeled using an initial state (<code>1</code>) based only on <code>mu</code> and subsequent states (<code>2</code> to <code>N</code>) based on the previous state and <code>tau</code> with a truncated Poisson observation:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># initial state</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>X[<span class="dv">1</span>] &lt;-<span class="st"> </span>mu;</span>
<span id="cb1-3"><a href="#cb1-3"></a>pred_count[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">c</span>(<span class="kw">exp</span>(X[<span class="dv">1</span>]) <span class="op">-</span><span class="st"> </span><span class="fl">0.1</span>, <span class="fl">0.00001</span>));</span>
<span id="cb1-4"><a href="#cb1-4"></a>count[<span class="dv">1</span>] <span class="op">~</span><span class="st"> </span><span class="kw">dpois</span>(<span class="kw">max</span>(<span class="kw">c</span>(<span class="kw">exp</span>(X[<span class="dv">1</span>]) <span class="op">-</span><span class="st"> </span><span class="fl">0.1</span>, <span class="fl">0.00001</span>))) <span class="kw">T</span>(<span class="dv">0</span>,ntraps[<span class="dv">1</span>]);</span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># through time</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>N) {</span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="co"># Process model</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>  predX[i] &lt;-<span class="st"> </span>X[i<span class="dv">-1</span>];</span>
<span id="cb1-10"><a href="#cb1-10"></a>  checkX[i] <span class="op">~</span><span class="st"> </span><span class="kw">dnorm</span>(predX[i], tau); </span>
<span id="cb1-11"><a href="#cb1-11"></a>  X[i] &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">c</span>(checkX[i], <span class="kw">log</span>(ntraps[i] <span class="op">+</span><span class="st"> </span><span class="dv">1</span>))); </span>
<span id="cb1-12"><a href="#cb1-12"></a>  pred_count[i] &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">c</span>(<span class="kw">exp</span>(X[i]) <span class="op">-</span><span class="st"> </span><span class="fl">0.1</span>, <span class="fl">0.00001</span>));</span>
<span id="cb1-13"><a href="#cb1-13"></a>   </span>
<span id="cb1-14"><a href="#cb1-14"></a>  <span class="co"># observation model</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>  count[i] <span class="op">~</span><span class="st"> </span><span class="kw">dpois</span>(<span class="kw">max</span>(<span class="kw">c</span>(<span class="kw">exp</span>(X[i]) <span class="op">-</span><span class="st"> </span><span class="fl">0.1</span>, <span class="fl">0.00001</span>))) <span class="kw">T</span>(<span class="dv">0</span>, ntraps[i]); </span>
<span id="cb1-16"><a href="#cb1-16"></a>}</span></code></pre></div>
<p>where <code>X</code> is used to track the state, <code>predX</code> is the mean/predicted value for the next step, <code>checkX</code> is the initial draw from the process model that has an overflow check on it (the <code>min</code> call) before passing the value to <code>X</code>, and <code>pred_count</code> is the natural-scale mean density, used as the parameter for the observation process. The offset (<code>0.1</code>) is removed here after being added in the priors (see below), and the <code>max</code> ensures that the parameter remains positive after the offset is removed.</p>
<p>The truncation and overflow protection are especially important here, as a log-scale density on a random walk has the potential to explode (run to <code>Inf</code>). However, it is possible that any model fit using JAGS could encounter some iterations of the algorithm that run to <code>Inf</code> (even if exceedingly rare), and so it is suggested for users that build JAGS <strong>portalcasting</strong> models to retain these or similar edge protections.</p>
<p>The two model parameters (<code>mu</code> and <code>tau</code>) are assumed to be distributed according to the available data that are from before <code>start_moon</code> (the start of the time series used to fit the model. In particular, <code>mu</code>, which is the log-scale density of rodents at time step 1 is considered to be drawn from a normal distribution with a mean equal to the prior average log-scale density of rodents and with a variance that is twice as large as the variance among prior log-scale density observations. Also, <code>tau</code> (the precision of the random walk) has a prior that is gamma distributed with a fixed rate of 0.1 and a rate-scaled shape equal to the mean of the distribution, which was set as the precision of the prior counts.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># priors</span>
  <span class="va">log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">past_count</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">)</span>
  <span class="va">mean_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">log_past_count</span><span class="op">)</span>
  <span class="va">sd_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">log_past_count</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>
  <span class="va">var_log_past_count</span> <span class="op">&lt;-</span> <span class="va">sd_log_past_count</span><span class="op">^</span><span class="fl">2</span>
  <span class="va">precision_log_past_count</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">var_log_past_count</span><span class="op">)</span>

  <span class="va">diff_count</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">log_past_count</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">log_past_count</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">diff_time</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">past_moon</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">past_moon</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> 
  <span class="va">diff_log_past_count</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">diff_count</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">diff_time</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">past_N</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">diff_count</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">log_past_count</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">log_past_count</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
    <span class="va">diff_time</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">past_moon</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">past_moon</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> 
    <span class="va">diff_log_past_count</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">diff_count</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="va">diff_time</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
  <span class="op">}</span>    
  <span class="va">sd_diff_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">diff_log_past_count</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>
  <span class="va">var_diff_log_past_count</span> <span class="op">&lt;-</span> <span class="va">sd_diff_log_past_count</span><span class="op">^</span><span class="fl">2</span>
  <span class="va">precision_diff_log_past_count</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">var_diff_log_past_count</span><span class="op">)</span>
  <span class="va">rate</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>
  <span class="va">shape</span> <span class="op">&lt;-</span> <span class="va">precision_diff_log_past_count</span> <span class="op">*</span> <span class="va">rate</span>

  <span class="va">mu</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">mean_log_past_count</span>, <span class="va">precision_log_past_count</span><span class="op">)</span>; 
  <span class="va">tau</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">shape</span>, <span class="va">rate</span><span class="op">)</span>; </code></pre></div>
<p>The priors and time series components are then combined into a single character value for input:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">jags_model</span> <span class="op">&lt;-</span> <span class="st">[1484 chars quoted with '"']</span></code></pre></div>
<p>As a starting point, we used an initializer function (<code>inits</code>) that draws starting values for the MCMC from the prior distributions. In addition, because we anticipate multiple chains, we include random number generator and input components. The <code>inits</code> function takes the data provided as input, thus allowing use of the prior data, and returns a function that can be used within <code><a href="https://rdrr.io/pkg/runjags/man/run.jags.html" class="external-link">runjags::run.jags</a></code> for a given chain:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">inits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span>
  <span class="va">rngs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"base::Wichmann-Hill"</span>, <span class="st">"base::Marsaglia-Multicarry"</span>,
            <span class="st">"base::Super-Duper"</span>, <span class="st">"base::Mersenne-Twister"</span><span class="op">)</span>
  <span class="va">past_N</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">past_N</span> 
  <span class="va">past_count</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">past_count</span> 
  <span class="va">past_moon</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">past_moon</span>

  <span class="va">log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">past_count</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">)</span>
  <span class="va">mean_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">log_past_count</span><span class="op">)</span>
  <span class="va">sd_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">log_past_count</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>
  <span class="va">diff_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">past_N</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">past_N</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">diff_count</span> <span class="op">&lt;-</span> <span class="va">log_past_count</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">log_past_count</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
    <span class="va">diff_time</span> <span class="op">&lt;-</span> <span class="va">past_moon</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">past_moon</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> 
    <span class="va">diff_log_past_count</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">diff_count</span> <span class="op">/</span> <span class="va">diff_time</span>
  <span class="op">}</span>
  <span class="va">sd_diff_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">diff_log_past_count</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>
  <span class="va">var_diff_log_past_count</span> <span class="op">&lt;-</span> <span class="va">sd_diff_log_past_count</span><span class="op">^</span><span class="fl">2</span>
  <span class="va">precision_diff_log_past_count</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">var_diff_log_past_count</span><span class="op">)</span>
  <span class="va">rate</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>
  <span class="va">shape</span> <span class="op">&lt;-</span> <span class="va">precision_diff_log_past_count</span> <span class="op">*</span> <span class="va">rate</span>

  <span class="kw">function</span><span class="op">(</span><span class="va">chain</span> <span class="op">=</span> <span class="va">chain</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.RNG.name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">rngs</span>, <span class="fl">1</span><span class="op">)</span>,
         .RNG.seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1e+06</span>, <span class="fl">1</span><span class="op">)</span>,
          mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mean_log_past_count</span>, <span class="va">sd_log_past_count</span><span class="op">)</span>, 
          tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, shape <span class="op">=</span> <span class="va">shape</span>, rate <span class="op">=</span> <span class="va">rate</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Finally, we tell the software to track both parameters through the <code>monitor</code> vector:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="va">monitor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"tau"</span><span class="op">)</span></code></pre></div>
<p>These components can then be combined within a function (like <code>jags_RW</code>) to leverage the internal functionality of <code>jags_ss</code> and flexibility of <code>runjags_control</code>. Because <code>jags_ss</code> process and packages the output for the casting standards, nothing in particular needs to be added in the wrapper function <code>jags_RW</code> after calling <code>jags_ss</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">jags_RW</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">main</span> <span class="op">=</span> <span class="st">"."</span>, <span class="va">data_set</span> <span class="op">=</span> <span class="st">"all"</span>,  
                    <span class="va">control_files</span> <span class="op">=</span> <span class="fu"><a href="../reference/files_control.html">files_control</a></span><span class="op">(</span><span class="op">)</span>, 
                    <span class="va">control_runjags</span> <span class="op">=</span> <span class="fu"><a href="../reference/runjags_control.html">runjags_control</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">lag</span> <span class="op">=</span> <span class="cn">NA</span>, 
                    <span class="va">quiet</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">verbose</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">arg_checks</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="../reference/argument_checking.html">check_args</a></span><span class="op">(</span>arg_checks <span class="op">=</span> <span class="va">arg_checks</span><span class="op">)</span>
  <span class="va">data_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">data_set</span><span class="op">)</span>
  
  <span class="va">monitor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mu"</span>, <span class="st">"tau"</span><span class="op">)</span>
  <span class="va">inits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span>
    <span class="va">rngs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"base::Wichmann-Hill"</span>, <span class="st">"base::Marsaglia-Multicarry"</span>,
              <span class="st">"base::Super-Duper"</span>, <span class="st">"base::Mersenne-Twister"</span><span class="op">)</span>
    <span class="va">past_N</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">past_N</span> 
    <span class="va">past_count</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">past_count</span> 
    <span class="va">past_moon</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">past_moon</span>

    <span class="va">log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">past_count</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">)</span>
    <span class="va">mean_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">log_past_count</span><span class="op">)</span>
    <span class="va">sd_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">log_past_count</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>
    <span class="va">diff_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">past_N</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">past_N</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      <span class="va">diff_count</span> <span class="op">&lt;-</span> <span class="va">log_past_count</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">log_past_count</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
      <span class="va">diff_time</span> <span class="op">&lt;-</span> <span class="va">past_moon</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">past_moon</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> 
      <span class="va">diff_log_past_count</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">diff_count</span> <span class="op">/</span> <span class="va">diff_time</span>
    <span class="op">}</span>
    <span class="va">sd_diff_log_past_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">diff_log_past_count</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>
    <span class="va">var_diff_log_past_count</span> <span class="op">&lt;-</span> <span class="va">sd_diff_log_past_count</span><span class="op">^</span><span class="fl">2</span>
    <span class="va">precision_diff_log_past_count</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">var_diff_log_past_count</span><span class="op">)</span>
    <span class="va">rate</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>
    <span class="va">shape</span> <span class="op">&lt;-</span> <span class="va">precision_diff_log_past_count</span> <span class="op">*</span> <span class="va">rate</span>

    <span class="kw">function</span><span class="op">(</span><span class="va">chain</span> <span class="op">=</span> <span class="va">chain</span><span class="op">)</span><span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.RNG.name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">rngs</span>, <span class="fl">1</span><span class="op">)</span>,
           .RNG.seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1e+06</span>, <span class="fl">1</span><span class="op">)</span>,
            mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mean_log_past_count</span>, <span class="va">sd_log_past_count</span><span class="op">)</span>, 
            tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, shape <span class="op">=</span> <span class="va">shape</span>, rate <span class="op">=</span> <span class="va">rate</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>
  <span class="va">jags_model</span> <span class="op">&lt;-</span> <span class="st">[1555 chars quoted with '"']</span>
  <span class="fu"><a href="../reference/jags_ss.html">jags_ss</a></span><span class="op">(</span>main <span class="op">=</span> <span class="va">main</span>, data_set <span class="op">=</span> <span class="va">data_set</span>, control_files <span class="op">=</span> <span class="va">control_files</span>,
          control_runjags <span class="op">=</span> <span class="va">control_runjags</span>, jags_model <span class="op">=</span> <span class="va">jags_model</span>,
          monitor <span class="op">=</span> <span class="va">monitor</span>, inits <span class="op">=</span> <span class="va">inits</span>, lag <span class="op">=</span> <span class="va">lag</span>, quiet <span class="op">=</span> <span class="va">quiet</span>, 
          verbose <span class="op">=</span> <span class="va">verbose</span>, arg_checks <span class="op">=</span> <span class="va">arg_checks</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Running this model in the forecasting pipeline produces standard output (allowing it to be integrated with the other cast output) and highlights the starting point for more mechanistic time series models.</p>
</div>
</div>
</div>
<div class="section level2 unnumbered">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references">
<div id="ref-Denwood2016">
<p>Denwood, M. J. 2016. “runjags: An R Package Providing Interface Utilities, Model Templates, Parallel Computing Methods and Additional Distributions for MCMC Models in JAGS.” <em>Journal of Statistical Software</em> 71 (9): 1–25. <a href="https://www.jstatsoft.org/article/view/v071i09" class="external-link">https://www.jstatsoft.org/article/view/v071i09</a>.</p>
</div>
<div id="ref-Plummer2003">
<p>Plummer, M. 2003. “A Program for Analysis of Bayesian Graphical Models Using Gibbs Sampling.” <em>Proceedings of the 3rd International Workshop on Distributed Statistical Computing</em>. <a href="http://www.ci.tuwien.ac.at/Conferences/DSC-2003/Proceedings/Plummer.pdf" class="external-link">http://www.ci.tuwien.ac.at/Conferences/DSC-2003/Proceedings/Plummer.pdf</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Juniper L. Simonis, Glenda M. Yenni, Ellen K. Bledsoe, Erica M. Christensen, Henry Senyondo, Hao Ye, Ethan P. White, S.K. Morgan Ernest.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.0.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
